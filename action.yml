name: "Setup TestLens"
description: "Performs TestLens setup"
inputs:
  github-token:
    description: "The GitHub token used for authentication"
    required: true
    default: ${{ github.token }}
  instrumentation-version:
    description: "The version of app.testlens:junit-platform-instrumentation to use"
    required: true
    default: "1.3.0"
  writeLogFile:
    description: "Writes diagnostic output to log files and attaches them as artifacts to the workflow run"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Add Gradle init script
      shell: bash
      env:
        TESTLENS_PROJECT_ID: ${{ github.repository }}
        TESTLENS_GITHUB_TOKEN: ${{ inputs.github-token }}
        INSTRUMENTATION_VERSION: ${{ inputs.instrumentation-version }}
        RUNNER_OS: ${{ runner.os }}
        WORKSPACE_PATH: ${{ github.workspace }}
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          WORKSPACE_PATH=$(echo "$WORKSPACE_PATH" | sed 's|\\|/|g')
        fi
        cat << EOF > $GRADLE_USER_HOME/init.d/testlens-init.gradle
        gradle.allprojects {
          if (new File('$WORKSPACE_PATH').absoluteFile == rootProject.projectDir.absoluteFile) {
            plugins.withId('java') {
              testing.suites.configureEach {
                dependencies { runtimeOnly('app.testlens:junit-platform-instrumentation:$INSTRUMENTATION_VERSION') }
              }
            }
            tasks.withType(Test).configureEach { task ->
              def muteMarker = new File(task.temporaryDir, "testlens-mute.marker")
              def logsDir = new File(task.temporaryDir, "testlens-logs")
              task.environment('TESTLENS_PROJECT_ID', '$TESTLENS_PROJECT_ID')
              task.environment('TESTLENS_GITHUB_TOKEN', '$TESTLENS_GITHUB_TOKEN')
              task.environment('TESTLENS_WORK_UNIT_PATH', task.path)
              task.environment("TESTLENS_MUTE_MARKER_FILE", muteMarker.absolutePath)
              task.environment("TESTLENS_LOGS_DIR", logsDir.absolutePath)
              task.addTestListener(new TestListener() {
                void beforeTest(TestDescriptor __) {}
                void afterTest(TestDescriptor __, TestResult ___) {}
                void beforeSuite(TestDescriptor __) {}
                void afterSuite(TestDescriptor __, TestResult ___) {
                  if (muteMarker.isFile()) {
                    task.outputs.doNotStoreInCache()
                    muteMarker.delete()
                  }
                }
              })
            }
          }
        }
        EOF
    - uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      if: ${{ inputs.writeLogFile == 'true' }}
      with:
        name: "TestLens logs"
        path: "**/testlens-logs/**"
